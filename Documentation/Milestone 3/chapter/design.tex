\chapter{Design}
\label{ch:design}

    This chapter will detail the design decisions made for the project's hardware and software systems, that ultimately led to us being able to successfully implement our systems and meet the original requirements set out by our clients. The following sections will break down our final product into two systems, the walking aid device and the wearable device, detailing the design decisions made for each system, including which technologies were used and UML diagrams of the systems. We will begin by detailing the design choices we made that impact both systems before breaking down our design decisions that individually impact the walking aid and wearable devices.

    \section{Both Devices}
    \label{sec:both_devices}

        This section will contain information on the design decisions we made that impacted both the wearable and walking aid devices. This will include software and hardware decisions to allow us to implement a communications system, to allow us to keep device form factor and power usage to a minimum, and the decisions of why we chose pieces of hardware that are common between both devices.

        \subsection{Development Board - TinyPICO}
        \label{subsec:development_board}

            The development board for each device would provide the necessary communication between multiple hardware components to allow us to reach the originally defined user requirements. Due to our previous experience with ESP32 chips and due to the necessity of our devices being of a small enough form factor to fit on the limbs of patients and on walking aids, we decided to use the TinyPICO development boards. Their use of ESP32 chips provide the basis for our communication system which utilises a Wi-Fi module, and provides adequate pin outs to allow us to communicate to each hardware device that we include within our systems. This is all achieved whilst keeping power usage to a minimum and allowing us to meet the client requirement of creating devices that are able to operate for a substantial amount of time without the need for battery replacements. The 240MHz dual-core chip that is the ESP32, would provide performance that allows our system to react to incoming communication from the Wi-Fi module or accelerometer promptly to provide a responsive system for our clients. The vast documentation supporting the development of embedded systems using ESP32s was instrumental in the success of our project, and we feel that the decision to utilise TinyPICO development boards was the correct one because of it. We were also influenced to use TinyPICO development boards due to Swansea University allowing us to borrow two boards at no extra cost, which ultimately allowed us to remain within our £150 budget. Finally, the TinyPICO boards also provide a built-in LED which we utilised throughout project development for debugging purposes.

        \subsection{Programming Language - Arduino C (C/C++)}
        \label{subsec:programming_language}

            We decided to utilise the Arduino C (C++) programming language rather than using MicroPython to develop our embedded software due to C++'s superior efficiency over Python for the development of embedded software \cite{github_2014, dicola}. Other tools such as PlatformIO would have provided the basis to allow us to utilise C++ for our software development, but due to the benefits of our team having previous experience of using the Arduino IDE to develop embedded systems, espetially in the field of software development with ESP32 chips, we felt that our project would be better suited to being developed utilising the Arduino ecosystem. We were also aware that the handover of this project would mean that another team would be able to take on the role of advancing our code and felt that C++ provided the best platform for developing smaller and more self-explanatory code across multiple header and implementation files. This would mean that any developers that attempt to further develop our code in future, should find it rather simple to identify what each class and block of code is attempting to accomplish.

        \subsection{Accelerometer - Adafruit ADXL345}
        \label{subsec:accel}

            Within this project, the accelerometer would provide the basis for identifying movement of the patient and the walking aid. The vast documentation supporting the development of embedded systems using ADXL345 accelerometers was a substantial factor in why we opted to include them in our systems. They provide the functionality for the detection of various changes in acceleration such as activity detection, free fall detection and single-tap and double-tap detection. The single-tap detection feature of the ADXL345 provides the basis for movement detection on both devices due to the fact that it can detect changes in gravity to identify when a step has been taken. The single-tap detection feature also allows the system to still be utilised whether the user is wearing the wearable device on their wrist or ankle, with the single-tap detection feature also being able to detect when the walking aid is being lifted and placed back on the ground. The free fall detection feature provided by the ADXL means that future developers will be able to easily implement a free fall detection system, which would allow the client to have their stretch goal implemented into the project. We opted to use the ADXL345 over other accelerometers as it is one of the newer offerings of accelerometers from the well renowned and reliable brand, Adafruit. Because of this, the accelerometers were relatively easy and quick to source, whilst only costing £7 per unit and allowing us to remain within our £150 budget. Finally, with the walking aid's TinyPICO already having its Serial Peripheral Interface and 3.3V power pin outs being utilised by the I2S audio shield, the ADXL345 allowed us to use the TinyPICO's I\textsuperscript{2}C interface for communication between the accelerometer and the development board, and allowed us to use the 5V pin out provided by the TinyPICO to power the ADXL345 due to its built-in voltage regulator.

        \subsection{Communication Protocol - ESP-Now}
        \label{subsec:esp_now_comms}

            Within the details specified in our Milestone 2 interim progress report, we classified the advantages and disadvantages of various options for communication protocols for use within our project. The first of those communication protocols was ESP-Now, a communication technology developed by the creators of the ESP32 chip, Espressif, which utilises the ESP32's Wi-Fi module to communicate with other devices that contain ESP32 chips \cite{esp-now_overview}. The other two communication protocol options we could have utilised were Bluetooth Low Energy (BLE) and Ultra-wideband (UWB). Despite considerations to include the use of UWB within our project, it would have been far too expensive for us to implement, and thus we instantly rejected the notion of using UWB within our project. Therefore, we were left with a decision to either utilise BLE or ESP-Now for the communication standard between our walking aid and wearable device. For the rest of this section, we will detail the advantages and disadvantages to using ESP-Now for our communication system, with comparisons to BLE, before finally detailing why we ultimately opted to utilise ESP-Now.

            \newpage
            \subsubsection{Advantages and Disadvantages of ESP-Now with comparisons to BLE}
            \label{subsubsec:esp_now_advantages_disadvantages}

                \vspace{2em}
                \input{tables/nowTable.tex}
                \vspace{5em}

                We ultimately decided to use ESP-Now as our communication protocol due to its ease of implementation and due to the fact that it allows sketch sizes to be smaller \cite{random_nerd_tutorials} than the sketch sizes of BLE \cite{kolban_2018}. The significance to sketch sizes being smaller is that they allow for the larger memory storage spaces accounting for larger audio reminder files, as well as providing more responsive code for what is a time sensitive system. The lower throughput that ESP-Now provides in comparison to BLE should not be noticeable within our system due to the fact that we only ever send one word messages between our devices at a given time. However, the lower power efficiency of ESP-Now in comparison to BLE is a considerable disadvantage for use within this system. Having said this, ESP-Now is still regarded as being a low power solution and should still mean that the patient or carer will not need to remember to replace the batteries in their devices too often.

    \section{Walking Aid Device}
    \label{sec:walking_aid}

        The walking aid device is a device that can be used to detect movement of the walking aid. When the wearable device detects that the patient is walking, a message is sent to the walking aid device. Should the walking aid device detect that it is not moving when the patient is walking, it will play an audio reminder to the patient to take their walking aid with them. The following sections will detail the design choices we made for this system, where we will compare technologies that would have been suited to the system and which we chose to implement, as well as a UML design section which will include a class diagram of the developed software system and an activity diagram that demonstrates the workflow of the software that allows the device to meet our desired specification.

        \subsection{I2S Audio Shield}
        \label{subsec:i2s_audio_shield}

            For the purposes of handling the amplification of reminder audio files and transferring the analogue data of the reminder audio to an external speaker, we needed to select an audio shield. In this instance we selected the I2S Audio Shield \cite{unexpected_maker} on offer from Unexpected Maker, the creator of the TinyPICO development board that has been previously mentioned in section \ref{subsec:development_board}. What attracted the team to using this particular audio shield was the fact that it already included the necessary hardware for handling the audio reminder system. That is that it contains a micro-SD card slot for the reading of the user's reminder audio file, external speaker output pins, and an amplifier to increase the volume of the audio in readiness to be transferred to the external speaker. With all these hardware devices housed on one audio shield, it made the design of the walking aid device casing more simple than an alternative that may have needed separate modules for the amplification of audio and the reading of a microSD card. In addition to this, our assumption was that acquiring separate hardware items from the same manufacturer would lead to a greater chance of our hardware devices communicating flawlessly with each other. To this end, we have not experienced any issues with the communication between the walking aid's TinyPICO and its audio shield. Therefore, we would say that in this instance, our assumption was correct.
            
            Alternative solutions could have taken the form of utilising the same ``MAX98357 I2S Decoder and Amp'' \cite{unexpected_maker} as the one used by the I2S Audio Shield we selected, but instead combining it with a separate dedicated micro-SD card reader, such as this offering \cite{ada_2022} from the well known embedded hardware manufacturer, Adafruit. The wiring and code development in this instance would have been identical, but we appreciated the fact that the Unexpected Maker solution houses the I2S decoder and amplifier on the same board as the microSD card reader. Along with this, the I2S audio shield is of a similar form factor to the TinyPICO development board and made the 3D modelling and printing process a simpler process.

        \subsection{SD Card Reading Library - SdFat}
        \label{subsec:sdfat}

            The decision to use the SdFat library by Bill Greiman \cite{greiman} was an unexpected one as Arduino provide their own solution of SD card reading library \cite{arduino} which acts as a wrapper to the SdFat library for easier understanding and further abstraction of the underlying code. However, when testing the transfer of an 150 KB mp3 file to the SPIFFS storage location of the TinyPICO, we began to notice that the library was taking an abnormally long time to complete the process, especially with a file this small. Upon completing research on the transfer speeds of the Arduino SD library, it was clear to see that the library had not been tested or optimised adequately enough to be used for the fast transferring of audio files from the microSD card to SPIFFS within our walking aid device. Discussion of these issues are widespread \cite{fat16lib_2011,drdooom_2019} with one GitHub user claiming that the SdFat library is ``85 times faster'' \cite{kas2_2018} than the Arduino SD library. Our own testing demonstrated transfer times of the 150 KB mp3 file from the microSD card to SPIFFS at around 150 seconds for the Arduino SD library, and around 12 seconds for the SdFat library. More information on this is viewable within the testing section of this document. But with such a stark difference in transfer rates, and with fast transfer rates being crucial for the prompt initialisation of our systems, we felt that the SdFat library was the most appropriate solution for our purposes.

        \subsection{UML}
        \label{subsec:uml}
        
            This section will break down the software systems utilised in the walking aid device into formal language representations. These will take the form of a class diagram, which will illustrate the relationships between each of classes developed for each system, and an activity diagram which will demonstrate the sequence of events that will take place in the system and how they are handled. We hope that this section will help the reader to understand the software system in a broken down, step-by-step manner and to gain an understanding of our rationale towards programming choices that helped us to fulfil the user requirements. The class diagrams will be followed by an explanation of the role of each class and its functions, with the activity diagram also being accompanied by a body of text that establishes in natural language the sequence of events that will take place in the software system and how they are being handled.

            \subsubsection{Class Diagram}
            \label{subsubsec:class_diagram}

                To demonstrate how the classes within the software are laid out and how they communicate with one another to make up the whole system, we include here a class diagram. Following the class diagram, we will include documentation on what each class and their functions towards benefitting the functionality of the system. 

                \clearpage
                \thispagestyle{empty}
                \begin{landscape}
                    \input{graphics/walking_aid_uml.tex}
                \end{landscape}
                
    \section{Wearable Device}
    \label{sec:wearabledevice}

        The wearable device is one that can be worn on the limbs of the patients to identify when the patient has begun walking. When walking is detected, communication occurs between the walking aid and wearable device to identify if the walking aid device is moving also. 

        \subsection{Walking Detection Technique - Single-Tap Detection}
        \label{subsec:walking_detection_technique}

           With the movement detection of the walking aid device, it was an obvious decision to utilise the single-tap detection feature of the ADXL345 accelerometer. We assume that the walking aid will take the form of a walking stick or Zimmer frame like structure, with movement likely to include lifting and placing. The placing event will cause a change in gravity through the Z-Axis of the accelerometer, and thus will allow the accelerometer to notice a tap being detected.

           The decision of what system to use to detect movement in the wearable device was less simple. Options included using a similar single-tap detection system, a system that utilises changes in acceleration to detect walking, or a system that uses the Bluetooth Low Energy (BLE) technology of each device to measure changes in distances between them. With the option of utilising BLE technology to detect walking, we would have needed to also utilise an accelerometer on one of the devices still to gain an understanding of which device was moving. However, the use of BLE technology for this use case would have been inadequate due to its potential for distance calculation inaccuracies of up to several metres \cite{Fachri_2019}. 

           Therefore, we were left with the utilisation of the ADXL345 accelerometer for the detection of the user walking. To decide on which solution of accelerometer system to use, we decided to develop both the single-tap detection system and the acceleration change detection system and compare them in real world testing. For our system, the single-tap detection system seemed to work better in attempting to detect walking, where the system attempting to detect changes in acceleration struggled with also detecting any movements in the accelerometer. The single-tap detection system would also be beneficial to us as it would be implementable on both the walking aid and wearable devices. Another benefit to the single-tap detection solution is that it allows versatility as to where the wearable device can be placed, with testing proving that the devices can detect walking on both the user's wrist and their ankle. 

           Ultimately, we decided to implement the single-tap detection system within the wearable device to detect when the user was walking. We make use of a system that checks if the user makes 5 steps within a 10-second period in order to meet the user requirement of reminders only being played if the user has moved over a metre without their walking aid. If they do, then we send a message to the walking aid device to play an audio reminder to the patient to take their walking aid with them if the walking aid device has not detected movement. The main benefits to this system is its versatility to be worn on the user's wrist or ankle, and it provided the foundations to the similar system that has been developed for the walking aid device. In future, we would like to explore the use of the aforementioned ultra-wideband technology (UWB). Due to its distance measurement error being within 10 cm \cite{uwb_accuracy}, it would have been interesting to implement this within the wearable device, and implement it into the walking aid device working in conjunction with an accelerometer to detect if the walking aid is moving.

    \section{Class Documentation - Walking Aid}
    \label{sec:class_documentation_walk_aid}\mbox{}

        \input{chapter/docs/walking_aid/sdtospiffs.tex}



